# ==== Purpose ====
#
# Test verifies the truncation of single binary log file.
#
# ==== Implementation ====
#
# Steps:
#    0 - Create table t1 and insert a row.
#    1 - Insert an another row such that it gets written to binlog but commit
#        in engine fails as server crashed at this point.
#    2 - Restart server with --tc-heuristic-recover=ROLLBACK
#    3 - Upon server start 'master-bin.000001' will be truncated to contain
#        only the first insert
#
# ==== References ====
#
# MDEV-21117: --tc-heuristic-recover=rollback is not replication safe


--source include/have_innodb.inc
--source include/have_log_bin.inc
--source include/have_debug.inc
--source include/have_binlog_format_statement.inc

call mtr.add_suppression("Can't init tc log");
call mtr.add_suppression("Aborting");

connect(master,localhost,root,,);
connect(master1,localhost,root,,);

--connection master
RESET MASTER;
CREATE TABLE t ( f INT ) ENGINE=INNODB;
INSERT INTO t VALUES (10);

--connection master1
--write_file $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
wait
EOF

SET GLOBAL DEBUG_DBUG="d,simulate_crash_after_binlog_write";
--error 2013 # CR_SERVER_LOST
INSERT INTO t VALUES (20);
--source include/wait_until_disconnected.inc

--connection master
--source include/wait_until_disconnected.inc

#
# Server restart
#
--append_file $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
restart: --tc-heuristic-recover=ROLLBACK
EOF
--source include/wait_until_disconnected.inc

--append_file $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
restart:
EOF

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc

--connection master
--enable_reconnect
--source include/wait_until_connected_again.inc

--connection master
SELECT * FROM t;
--source include/show_binlog_events.inc

--connection master
DROP TABLE t;
let $binlog_file= query_get_value(SHOW MASTER STATUS, File, 1);
--source include/show_gtid_list.inc
